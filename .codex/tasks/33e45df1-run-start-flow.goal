# Goal: Operationalize Run Configuration Modifiers

## Summary
The run startup experience now ships as a multi-step wizard that fetches `/run/config` metadata, guides party selection, and posts the full `run_type` plus modifier payload back to the backend while emitting telemetry for each step.【F:frontend/src/lib/components/RunChooser.svelte†L1-L462】【F:frontend/tests/run-wizard-flow.vitest.js†L1-L120】 The UI API normalizes these selections before calling `start_run`, and the service layer validates the configuration, persists a snapshot on the run record, and logs tracking events that include reward bonuses and the chosen metadata version.【F:frontend/src/lib/systems/uiApi.js†L50-L128】【F:backend/services/run_service.py†L171-L333】【F:backend/tracking/service.py†L102-L132】 Session-level caching now reuses previously fetched metadata until the backend hash changes, while the wizard exposes recently used modifier presets as quick-start shortcuts so returning players can reapply stacks with reward previews and metadata badges.【F:frontend/src/lib/systems/uiApi.js†L7-L249】【F:frontend/src/lib/components/RunChooser.svelte†L43-L414】【F:frontend/tests/run-wizard-flow.vitest.js†L299-L413】 Run configuration metadata enumerates rich modifier semantics, but in play the only consumer is the boss-rush shortcut in the map generator; foe scaling, shop pricing, and encounter odds still rely on legacy pressure heuristics.【F:backend/services/run_configuration.py†L132-L520】【F:backend/autofighter/mapgen.py†L145-L154】【F:backend/autofighter/rooms/foe_factory.py†L32-L200】【F:backend/autofighter/rooms/shop.py†L19-L178】

## Completed Work
- The RunChooser modifier stage now hydrates reward previews, stacking rules, and effect copy directly from backend metadata, exposing uncapped stacking warnings, reward breakdowns, and preview chips while anchoring the layout to the full panel height to eliminate phantom scrollbars.【F:frontend/src/lib/components/RunChooser.svelte†L360-L1660】
- UI regression coverage exercises the new tooltip copy, reward previews, and layout bindings for foe, player, and economy modifiers to keep the wizard experience aligned with the metadata schema.【F:frontend/tests/run-wizard-flow.vitest.js†L1-L286】
- Run configuration metadata is cached in session storage with hash-aware invalidation, and the wizard persists recent modifier presets (including metadata signatures) to offer quick-start buttons that replay stacks, fire telemetry, and highlight stale configurations via metadata badges.【F:frontend/src/lib/systems/uiApi.js†L7-L249】【F:frontend/src/lib/components/RunChooser.svelte†L43-L414】【F:frontend/tests/run-wizard-flow.vitest.js†L299-L413】

## Current State Observations
- `RunChooser` replaces the legacy single-click overlay with a resume gate, party builder, run type chooser, modifier configuration, and confirmation screen, persisting defaults to local storage and logging impressions/actions via `log_menu_action`.【F:frontend/src/lib/components/RunChooser.svelte†L13-L414】
- The modifier configuration step renders metadata-driven tooltips, reward previews, and stacking copy, ensuring the CTA stays anchored unless content genuinely overflows.【F:frontend/src/lib/components/RunChooser.svelte†L360-L1660】【F:frontend/tests/run-wizard-flow.vitest.js†L249-L286】
- UI tests cover the wizard flow, ensuring metadata errors surface, modifier changes persist, and telemetry calls fire as expected.【F:frontend/tests/run-wizard-flow.vitest.js†L33-L117】
- `start_run` stores a configuration snapshot (including client metadata version), scales party EXP/RDR multipliers, writes the snapshot into the save data, and forwards the enriched payload to telemetry and tracking tables.【F:backend/services/run_service.py†L171-L333】【F:backend/tracking/service.py†L102-L132】
- Metadata helpers define per-modifier effects, diminishing returns, and reward formulas, yet no runtime systems besides boss-rush detection read those values; `MapGenerator`, `FoeFactory`, and shop pricing continue to use hard-coded pressure coefficients.【F:backend/services/run_configuration.py†L132-L520】【F:backend/autofighter/mapgen.py†L145-L154】【F:backend/autofighter/rooms/foe_factory.py†L32-L200】【F:backend/autofighter/rooms/shop.py†L19-L178】

## Desired Outcomes
1. **Metadata consumption & UX polish**
   - Add UX affordances for managing the recent preset list—such as pinning favorites, clearing stale entries when metadata hashes diverge, and surfacing cross-account sync hints—to keep the quick-start rail trustworthy for frequent players.【F:frontend/src/lib/components/RunChooser.svelte†L43-L414】
   - Explore server-provided or community-recommended modifier presets that can coexist with locally remembered configurations, ensuring metadata caching still differentiates between local and remote sources.【F:frontend/src/lib/systems/uiApi.js†L7-L249】【F:frontend/src/lib/components/RunChooser.svelte†L341-L375】
2. **Gameplay integration of run modifiers**
   - Thread the stored `run_config` snapshot through map generation and encounter assembly so modifier stacks influence spawn counts, elite/prime/glitched odds, and foe stat scaling instead of relying solely on static pressure math.【F:backend/autofighter/mapgen.py†L145-L154】【F:backend/autofighter/rooms/foe_factory.py†L32-L200】
   - Apply foe- and player-focused modifiers when instantiating combatants (HP, mitigation, vitality, action speed) and when calculating player stat penalties/bonuses, leveraging the effect data already exposed in `RunConfigurationSelection`.【F:backend/services/run_configuration.py†L132-L520】【F:backend/services/run_service.py†L171-L333】
   - Extend shop generation and pricing logic to respect modifier-driven shop multipliers or tax rules instead of the fixed `1.26^pressure` curve, ensuring preview math in the wizard matches in-game economy behavior.【F:backend/autofighter/rooms/shop.py†L19-L178】【F:frontend/src/lib/components/RunChooser.svelte†L416-L439】
3. **Analytics and surfacing follow-through**
   - Expose the persisted configuration snapshot during active runs (e.g., map HUD, pause overlays) so players can verify modifiers mid-run, mirroring the battle review panel’s configuration summary.【F:frontend/src/lib/components/battle-review/BattleReviewMenu.svelte†L285-L314】【F:frontend/src/lib/components/OverlayHost.svelte†L285-L294】
   - Expand tracking queries or dashboards to aggregate modifier usage and reward outcomes now that `run_configurations` captures run type, modifier stacks, and reward multipliers for every session.【F:backend/tracking/service.py†L102-L132】
4. **Documentation & validation**
   - Update `.codex/implementation/game-workflow.md` and related onboarding docs to describe how modifiers affect gameplay systems once integrated.【F:.codex/implementation/game-workflow.md†L15-L48】
   - Add backend unit coverage for the new modifier hooks (e.g., foe factory scaling, shop pricing) and extend frontend tests if additional UI surfaces are introduced for mid-run visibility.【F:frontend/tests/run-wizard-flow.vitest.js†L33-L117】【F:backend/tests/test_run_configuration_service.py†L10-L64】

## Open Questions / Follow-ups
- Validate that the new tooltip warning about uncapped modifier stacking gives players enough context about extreme configurations or if we still need a dedicated difficulty callout elsewhere in the flow.
- What retention strategy should telemetry adopt for long-term modifier analytics (granularity, retention window, anonymization) now that richer payloads ship with each run start?
- Should recent presets expire automatically after extended inactivity, or should we surface a UI cue that metadata hashes no longer align with the current backend payload before auto-clearing entries?【F:frontend/src/lib/components/RunChooser.svelte†L43-L414】
