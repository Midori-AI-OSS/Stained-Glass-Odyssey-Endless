# Goal: Streamline Run Startup Workflow

## Summary
We need to replace the current single-click "Start Run" action with a guided setup that walks the player through building their party, choosing a run type, configuring run modifiers, and finally launching the run. Backend startup pruning now clears lingering runs automatically, the run-configuration metadata API is online, and `start_run` already persists selections with telemetry, so the remaining work centers on the frontend wizard, metadata UX polish, analytics follow-ups, and any configuration hooks the backend still lacks.

## Current State Observations
- Backend now prunes lingering runs on startup via the `prune_runs_on_startup` hook, so players begin each boot from a clean slate; `/ui` helpers also expose the run configuration metadata at `/run/config`, giving the frontend a stable source for run types, modifiers, and pressure tooltip copy.【F:backend/services/run_service.py†L46-L95】【F:backend/app.py†L1-L140】【F:backend/routes/ui.py†L520-L590】【F:backend/services/run_configuration.py†L340-L412】
- `start_run` validates run types and modifiers, persists the configuration snapshot on the run record, and emits telemetry payloads that include the chosen run type, modifier stacks, and derived reward bonuses, but the game flow still only reacts to pressure during map generation.【F:backend/services/run_service.py†L120-L260】【F:backend/services/run_configuration.py†L340-L412】
- The frontend Run overlay (`RunChooser`) remains a basic chooser that resumes or starts runs without any multi-step wizard, and the UI API continues to post only party, damage type, and pressure—ignoring the new metadata entirely.【F:frontend/src/lib/components/RunChooser.svelte†L1-L69】【F:frontend/src/lib/systems/uiApi.js†L1-L90】

## Desired Outcomes
1. Frontend run setup becomes a resilient multi-step wizard (Build Party → Choose Run Type → Configure Modifiers → Confirm & Start) that consumes the live metadata feed and replaces the legacy chooser.
2. Metadata UX conveys modifier effects, tooltips, and reward bonuses clearly, allowing players to preview pressure math and modifier penalties before launching a run.
3. Telemetry and analytics capture wizard interactions and final selections, with any missing dashboards or event schemas queued as follow-up tasks.
4. Backend gaps discovered during integration—such as map generation hooks for non-pressure modifiers or run-type-specific defaults—are documented and ticketed so they can be tackled next.

## Proposed Task Breakdown
1. **Frontend run setup wizard**
   - Replace `RunChooser` with a staged wizard that sequences Party Picker → Run Type → Modifier configuration → Review/confirmation, handling cancellations, retries, and accessibility concerns.【F:frontend/src/lib/components/RunChooser.svelte†L1-L69】
   - Wire the wizard into existing overlays and menu triggers so the single-click start flow disappears once the guided setup ships.【F:frontend/src/lib/systems/uiApi.js†L1-L90】
2. **Metadata consumption & UX polish**
   - Fetch `/run/config` metadata when opening the wizard, cache it client-side, and surface descriptions, tooltips, preview stacks, and reward bonuses alongside each control.【F:backend/routes/ui.py†L520-L590】【F:backend/services/run_configuration.py†L340-L412】
   - Ensure selections post full payloads back to the backend (`run_type`, `modifiers`, `pressure`) and persist client defaults for future sessions.【F:backend/services/run_service.py†L120-L260】
3. **Analytics and telemetry follow-ups**
   - Extend UI logging to capture wizard step impressions, modifier adjustments, and abandoned starts so downstream analytics teams can measure usage.【F:backend/services/run_service.py†L205-L260】
   - Confirm backend tracking (`log_run_start`, `log_menu_action`) receives the enriched configuration data and document any additional events or dashboards needed for product analytics.【F:backend/services/run_service.py†L205-L260】
4. **Backend configuration gaps**
   - Audit map generation, foe selection, and reward systems to determine how non-pressure modifiers should influence gameplay; document required hooks or create follow-up tickets where implementation is still missing.【F:backend/services/run_service.py†L191-L229】【F:backend/services/run_configuration.py†L340-L412】
   - Validate that saved run snapshots and restore flows propagate the stored configuration so future UI surfaces can display it accurately.【F:backend/services/run_service.py†L248-L260】【F:backend/routes/ui.py†L37-L210】
5. **Documentation & testing**
   - Refresh `.codex/implementation` notes and onboarding guides to explain the wizard, metadata contract, and telemetry responsibilities.
   - Add backend validation/unit tests for new modifier interactions plus frontend component/store tests covering the wizard state machine and persistence.

## Open Questions / Follow-ups
- What initial run types and modifiers should ship first (e.g., "Standard", "Boss Rush")? Define seed data before implementation.
- Should run configuration be persisted for analytics only or actively change map generation parameters (e.g., custom room counts per floor)? Coordinate with map generation specialists.
- Determine whether pressure defaults should vary per run type and how to handle unsupported combinations gracefully.

## References & Suggested Reading
- Run configuration metadata helpers in `backend/services/run_configuration.py` and the `/run/config` route in `backend/routes/ui.py` for the canonical schema and API surface.【F:backend/services/run_configuration.py†L1-L549】【F:backend/routes/ui.py†L520-L590】
- Run startup flow and telemetry logging in `backend/services/run_service.py` to understand how selections are persisted today.【F:backend/services/run_service.py†L120-L260】
- Current frontend run chooser and API glue in `frontend/src/lib/components/RunChooser.svelte` and `frontend/src/lib/systems/uiApi.js` to see what the wizard must replace.【F:frontend/src/lib/components/RunChooser.svelte†L1-L69】【F:frontend/src/lib/systems/uiApi.js†L1-L90】

ready for review
