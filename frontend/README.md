# Frontend

Svelte-based GUI served with Bun on port `59001`.

## Setup

```bash
cd frontend
bun install
bun dev
```

When running via Docker Compose, the `frontend/docker-entrypoint.sh` performs a one-time `bun run build` (if `build/` is missing) before starting the dev server. The build runs after `svelte-kit sync` and sets `VITE_API_BASE=/api` for static output. The entrypoint then waits 5 seconds to give the backend a head start and avoid the first page load racing the backend.

The dev server’s backend discovery now keeps retrying until a backend is reachable (rather than defaulting immediately). The browser also polls `/api-base` until available, so the UI will connect automatically as soon as the backend is up.

The development server runs at `http://localhost:59001` and displays a
high‑contrast action panel powered by `lucide-svelte`, with the run menu
mirroring the in-game overlays.

At startup the dev server probes common backend hosts and exposes the first
reachable one as `VITE_API_BASE` and through an `/api-base` endpoint. The
browser reads this value instead of scanning the network directly.

- Run: Opens the start-run flow. New runs walk through the Party Picker step
  so players can confirm or edit their lineup before the map loads; existing
  runs resume immediately and skip the party overlay.
- Warp: Calls `/gacha/pull` so players can recruit 5★ or 6★ characters or
  earn 1★–4★ upgrade items between runs. Pity raises the odds of higher‑tier
  items and upgrade materials auto‑craft in the background.
- Inventory: Opens the inventory overlay so players can inspect cards, relics,
  and upgrade materials between encounters.
- Battle Review: Launches the battle review menu, letting players revisit recent
  fights without starting a new run.
- Guidebook: Shows the reference overlay with tabs for damage types, ultimates,
  UI notes, shops, mechs, and passives sourced from backend endpoints.
- Settings: Opens a panel with sliders for sound effects, music, and voice
  that auto‑save and briefly show a “Saved” status. Also includes Reduced
  Motion and “End Run” controls. End Run immediately halts battle polling
  and returns home without residual snapshot requests.
- Feedback: Opens a pre‑filled GitHub issue in a new tab.
- Discord: Launches the community server in a new tab so testers can coordinate
  real-time feedback.
- Website: Opens the public project site.

Voice clips generated by the backend are referenced via `voice` URLs in API
responses. `viewportState.playVoice()` loads these clips and plays them using
the current `voiceVolume` setting.
During combat, party members appear in a left column and foes on the right,
with HP, Attack, Defense, Mitigation, and Crit rate listed beside each
portrait. HoT/DoT markers render below each portrait and collapse duplicate
effects into a single icon with a stack count. The previous blue/red enrage
flashing was replaced by red/blue rain lines that intensify with enrage and
gracefully fade after battles. At very high enrage the whole screen rains more
densely; Reduced Motion lowers density and disables animation.

After each battle, a four-phase reward overlay walks through Drops → Cards →
Relics → Review:

1. **Drops** — materials appear in a dedicated grid while floating pickups play
   out. The right rail lists the four phases but keeps the **Advance** button
   disabled until the controller marks Drops complete.
2. **Cards** — the first card auto-selects and wiggles to highlight the staged
   pick. Double-clicking (or pressing the selection a second time) confirms
   immediately, and the right-rail **Advance** button switches into a confirm
   mode for single-tap or accessibility flows.
3. **Relics** — mirrors the card interaction model, including staged
   confirmations, the Advance confirm fallback, reset handling, and the shared
   wiggle animation tokens.
4. **Battle Review** — mounts `BattleReview.svelte` with the familiar damage
   graphs and timeline view once all staged rewards resolve.

The right rail runs a 10-second countdown whenever a phase becomes actionable;
manual clicks or the timer call `rewardPhaseController.advance({ reason })` so
automation can log `manual` vs `auto` transitions. Idle automation listens for
the controller's `advance` events instead of calling `/ui?action=advance_room`
directly, preventing timer fights when the UI auto-advances first.

`CardArt.svelte` and `CurioChoice.svelte` power the card and relic panels using
assets from `src/lib/assets`. Gold and item drops float briefly on screen before
the overlay appears.
Placeholder icons for items, relics, and cards live under `src/lib/assets/{items,relics,cards}`. Asset names combine the star folder and base filename (e.g. `3star/omega_core.png`) so the frontend can resolve the correct image for a given reward. Each damage type or star rank has its own folder with 24×24 colored placeholders so artists can replace them later.

## Settings: Wipe Save Data
- The Wipe button calls the backend wipe endpoint and also clears all client storage and caches (localStorage, sessionStorage, IndexedDB, CacheStorage) and unregisters service workers. After completion it forces a full page reload to prevent stale roster or party selections from persisting.

## Asset Loading
- Backgrounds: a random image is selected from `src/lib/assets/backgrounds` whenever the viewport initializes.
- Character portraits: if `src/lib/assets/characters/<name>.png` exists it is used; otherwise if a folder `src/lib/assets/characters/<name>/` exists, a random `.png` inside that folder is used. If neither exists, a random fallback from `src/lib/assets/characters/fallbacks` is used, falling back to the Midori AI logo as a last resort.
- Battle effects: `.efkefc` files under `src/lib/assets/effects` power runtime animations. The current mapping expects `HitEffect.efkefc`, `Fire1.efkefc`, `Poison.efkefc`, and `HealOne1.efkefc` to be present.
