
name: Auto-Audit PR (SAFE)

on:
  pull_request:
    branches-ignore:
      - master
      - main
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  auditpr:
    runs-on: ubuntu-latest
    container:
      image: lunamidori5/pixelarch:quartz
      options: --cpus 1 --user root
    env:
      ALLOWED_USERS: |
        lunamidori5

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Create Copilot agent task via GitHub CLI
        if: ${{ contains(env.ALLOWED_USERS, github.event.pull_request.user.login) }}
        run: |
          # Only create an agent task when a task file in .codex/tasks contains the marker 'ready to review'
          echo "Checking .codex/tasks for 'ready to review'..."
          if [ -d ".codex/tasks" ] && grep -R -i -n "ready to review" .codex/tasks >/dev/null 2>&1; then
            echo "Found 'ready to review' in .codex/tasks - creating agent task(s) for matching file(s)"
            # collect file paths containing the marker (one per line)
            matches=$(grep -R -i -l "ready to review" .codex/tasks || true)
            if [ -z "$matches" ]; then
              echo "No matching files found after grep -- unexpected; exiting."
            else
              # create an agent task for each matching task file, include the file path in the task description
              echo "$matches" | while IFS= read -r f; do
                echo "Creating agent task for: $f"
                gh agent-task create "As an Auditor (read the codex mode file) audit $f" --follow
              done
            fi
          else
            echo "No 'ready to review' marker found in .codex/tasks; skipping agent task creation."
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Post PR hold comment and add thumbs-down reaction
        if: ${{ contains(env.ALLOWED_USERS, github.event.pull_request.user.login) }}
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const tasksPath = '.codex/tasks';
            let found = false;
            if (fs.existsSync(tasksPath)) {
              const entries = fs.readdirSync(tasksPath, { withFileTypes: true });
              for (const e of entries) {
                if (e.isFile()) {
                  const content = fs.readFileSync(`${tasksPath}/${e.name}`, 'utf8');
                  if (content.toLowerCase().includes('ready to review')) { found = true; break; }
                }
              }
            }
            if (found) {
              const prNumber = context.payload.pull_request.number;
              const body = "Automated audit started â€” please wait to merge this PR. Adding a thumbs-down reaction so other systems can react.";
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body
              });
              // add a thumbs-down reaction to the PR (issues API covers PRs)
              await github.rest.reactions.createForIssue({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                content: '-1'
              });
              core.info(`Posted hold comment and added thumbs-down reaction to PR #${prNumber}`);
            } else {
              core.info("No 'ready to review' marker found in .codex/tasks; skipping comment/reaction.");
            }
