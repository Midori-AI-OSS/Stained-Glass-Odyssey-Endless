name: E2E Tests - Sub Agent 2

on:
  workflow_dispatch:
  pull_request:
    paths:
      - 'frontend/**'
      - 'backend/**'
      - '.github/workflows/e2e-test-2.yml'

jobs:
  e2e-test:
    runs-on: ubuntu-latest
    timeout-minutes: 240
    
    strategy:
      fail-fast: false
      matrix:
        variant: [non-llm]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
      
      - name: Setup uv
        uses: astral-sh/setup-uv@v6.6.0
        with:
          python-version: '3.12'
      
      - name: Setup bun
        uses: oven-sh/setup-bun@v2.0.2
        with:
          bun-version: latest
      
      - name: Setup Python environment
        working-directory: backend
        run: |
          uv sync
      
      - name: Install backend variant dependencies
        working-directory: backend
        run: |
          case "${{ matrix.variant }}" in
            "llm-cpu")
              uv sync --extra llm-cpu
              ;;
            "llm-cuda")
              uv sync --extra llm-cuda
              ;;
            "llm-amd")
              uv sync --extra llm-amd
              ;;
          esac
      
      - name: Install frontend dependencies
        working-directory: frontend
        run: |
          bun install
      
      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: playwright-browsers-${{ runner.os }}-${{ hashFiles('frontend/bun.lockb') }}
      
      - name: Install Playwright browsers
        working-directory: frontend
        run: |
          bunx playwright install --with-deps chromium
      
      - name: Start backend server
        working-directory: backend
        run: |
          # Start backend in background and save PID
          uv run app.py &
          BACKEND_PID=$!
          echo "$BACKEND_PID" > ../backend.pid
          echo "BACKEND_PID=$BACKEND_PID" >> $GITHUB_ENV
          echo "Backend started with PID: $BACKEND_PID"
          
          # Wait for backend to fully start (takes ~10 seconds)
          echo "Waiting 15 seconds for backend to fully start..."
          sleep 15
      
      - name: Verify backend health
        run: |
          # Verify backend is responding with retries
          echo "Checking backend health at http://localhost:59002/"
          curl --retry 5 --retry-delay 2 --retry-all-errors -f http://localhost:59002/ || (echo "Backend failed to start" && exit 1)
          echo "Backend is healthy and ready!"
      
      - name: Run Playwright tests
        working-directory: frontend
        run: |
          bunx playwright test
        env:
          CI: true
      
      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report-${{ matrix.variant }}
          path: frontend/playwright-report/
          retention-days: 7
      
      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ matrix.variant }}
          path: frontend/test-results/
          retention-days: 7
      
      - name: Upload UI screenshots
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ui-screenshots-${{ matrix.variant }}
          path: frontend/screenshots/
          retention-days: 7
      
      - name: Cleanup backend server
        if: always()
        run: |
          # Stop backend using saved PID
          if [ -f backend.pid ]; then
            BACKEND_PID=$(cat backend.pid)
            echo "Stopping backend (PID: $BACKEND_PID)..."
            kill $BACKEND_PID 2>/dev/null || true
            rm backend.pid
          elif [ ! -z "$BACKEND_PID" ]; then
            echo "Stopping backend using env var (PID: $BACKEND_PID)..."
            kill $BACKEND_PID 2>/dev/null || true
          fi
          echo "Backend cleanup complete"
